---
title: "Accessibility impact of transport infrastructure: Spatial assessment of Bogota's future metro system"
author: "Andrés Restrepo Jiménez"
date: '2023-06-19'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
library(r5r)
library(accessibility)
library(ggplot2)
library(aopdata)
library(gtfstools)
library(readr)
library(dplyr)
library(tidyr)
library(st)
library(httr)
library(sf)
library(patchwork)
library(tmap)
library(tmaptools)
library(forcats)
library(scales)
library(writexl)
library(DataExplorer)
```

## Temporary directory


Location

```{r}
tempdir()
```

Deletes

```{r}
# unlink(tempdir(), recursive = TRUE)
```


## Memory setup

```{r}
options(java.parameters = "-Xmx6G")
```

# Bus Rapid Transit network (BRT)

## Downloading the data

Setting the temp file path

```{r}
brt_path <- tempfile("brt", fileext = ".zip")
```

Downloading the BRT GTFS data

```{r}
httr::GET(
  "https://www.arcgis.com/sharing/rest/content/items/6def68cda70c43ab8d93d74f43c5915a/data",
  httr::write_disk(brt_path)
)
```
The GTFS data is a static feed (2021-07-04) provided by the Transport Secretary of Bogota City Council.

## Data inspection


Review of tables of downloaded data

```{r}
unzip(brt_path, list = TRUE)
```

```{r}
brt_gtfs <- read_gtfs(brt_path)

names(brt_gtfs)
```
### Profiling

```{r}
plot_str(brt_gtfs)
```


### Agency

```{r}
head(brt_gtfs$agency)
```


### Routes

```{r}
head(brt_gtfs$routes)
```
#### Id

Number of rows in route table

```{r}
nrow(brt_gtfs$routes)
```
Number of route id's.

```{r}
n_distinct(brt_gtfs$routes$route_id)
```
There are 547 different routes in the BRT network.

#### Description

Number of descriptions

```{r}
n_distinct(brt_gtfs$routes$route_desc)
```
Description texts

```{r}
unique(brt_gtfs$routes$route_desc)
```
#### Type

Number of types

```{r}
n_distinct(brt_gtfs$routes$route_type)
```
Type texts

```{r}
unique(brt_gtfs$routes$route_type)
```
Consistent with official GTFS [specification](https://gtfs.org/schedule/reference/#routestxt).

### Trips

```{r}
head(brt_gtfs$trips)
```
__How can you tell the direction?__
__It does not have the shape id__

Number of routes in table

```{r}
n_distinct(brt_gtfs$trips$route_id)
```
Number of uniques entries

```{r}
n_distinct(brt_gtfs$trips)
```
There are 158976 trips included in the BRT GTFS data.

### Stops

```{r}
head(brt_gtfs$stops)
```
Number of stations

```{r}
n_distinct(brt_gtfs$stops)
```
Convert stops to sf

```{r}
brt_stations_sf <- st_as_sf(brt_gtfs$stops,coords = c("stop_lon", "stop_lat"))
```

Plot stations

```{r}
brt_stations_sf %>%
  st_geometry() %>%
  plot()
```

Basic geo map

```{r}
ggplot() +
  geom_sf(data = brt_stations_sf) +
  theme_minimal()
```




#### Id

Number of rows in station table

```{r}
n_distinct(brt_gtfs$stops$stop_id)
```
There are 7819 different stations in the BRT network.

#### Stop code

Number of rows in station table

```{r}
n_distinct(brt_gtfs$stops$stop_code)
```
Stop code and stop id seem to be equivalent.

### Calendar

```{r}
head(brt_gtfs$calendar)
```
From 1-5, it is the same schedule.

### Shape (non existing)

__Do we need to create one? How?__

#### Geometry

Getting geometry from stops location for trip in case 3.

```{r}
geo_from_stops_test <- gtfstools::get_trip_geometry(brt_gtfs, trip_id = c( "BC26E0001-2-3","BC26E0001-3-3"))
```

The new object is already a sf object.

Plotting

```{r}
plot(geo_from_stops_test)
```

Plotting geometry only


```{r}
geo_from_stops_test %>%
  st_geometry() %>%
  plot()
```

Basic geo map

```{r}
ggplot() +
  geom_sf(data = geo_from_stops_test) +
  theme_minimal()
```

#### Creating shape table

Orders the stop_times table based on the stop_sequence order.

```{r}
brt_gtfs$stop_times <- brt_gtfs$stop_times[
  order(trip_id, stop_sequence)
]
```

Creates a objects with all the geometries

```{r}
brt_shape <- gtfstools::get_trip_geometry(
  brt_gtfs)
```

##### Inspection of geometries object

There are 3039 unique geometries, so need to understand the duplicates structure.

Na values in geometries

```{r}
brt_shape %>%
  filter(is.na(geometry))
```


__It seems that there are some trips with no geometries.__

### Stops times

```{r}
summary(brt_gtfs$stop_times)
```



```{r}
head(brt_gtfs$stop_times)
```

```{r}
brt_gtfs$stop_times
```

Filter stop sequence 0 values

```{r}
filter(brt_gtfs$stop_times, stop_sequence == 0)
```

Count of 0 stop sequence values

```{r}
stop_cero_sequence <- filter(brt_gtfs$stop_times, stop_sequence == 0) %>%
  group_by(stop_id) %>%
  summarize(count_cero = n()) #%>%

stop_cero_sequence <- stop_cero_sequence[order(desc(stop_cero_sequence$count_cero)),]

```

Filtering the stop table

```{r}
filter(brt_gtfs$stops, stop_id == stop_cero_sequence$stop_id[1])
```



#### Trip Id


```{r}
n_distinct(brt_gtfs$stop_times$trip_id)
```

Sorting by trip id

```{r}
brt_gtfs$stop_times[order(trip_id)]
```

The BC26E0001-XX-3 suffix is a consecutive counter of the same service.

#### Stop sequence

__How to interpret the stop_sequence field?__

Unique value in stop_sequence field

```{r}
n_distinct(brt_gtfs$stop_times$stop_sequence)
```
Histogram on stop sequence values

```{r}
histo_stop_sequence <- ggplot(brt_gtfs$stop_times, aes(x=stop_sequence)) +
  ggtitle("Histogram of stop sequence values") + 
  geom_histogram() + xlab("Stop sequence")
histo_stop_sequence
```

Multiple stations with "1" values in the stop sequence.

Number of stops for each station

```{r}

```


Filter a specific trip

##### Case 1 

```{r}
filter(brt_gtfs$stop_times, trip_id == "BC26E0001-10-3")
```
Review of individual geometry

```{r}
geo_case_1 <- gtfstools::get_trip_geometry(brt_gtfs, trip_id = "BC26E0001-10-3")
```

The new object is already a sf object.

Plotting

```{r}
plot(geo_case_1)
```

Plotting geometry only


```{r}
geo_case_1 %>%
  st_geometry() %>%
  plot()
```

There is no geometry with only 0 and 1 values in stop sequence values.



##### Case 2 

```{r}
filter(brt_gtfs$stop_times, trip_id == "BC26E0005-19-3")
```
__Do a group by with 0 and 1 values in stop sequence__


##### Case 3 

```{r}
filter(brt_gtfs$stop_times, trip_id == "BC26E0001-2-3")
```

##### Stations with the most transit

It is not counting the stop secuence field

```{r}
trips_by_stop <- brt_gtfs$stop_times %>%
  group_by(stop_id) %>%
  summarize(count_transit = n())
  #trips_by_stop[order("count_by_stop_sequence")]

```

__Misleading count__

Adjusted count

```{r}
stops_by_trip <- brt_gtfs$stop_times %>%
  group_by(trip_id, stop_sequence) %>%
  summarize(count_stop_sequence = n()) %>%
  pivot_wider(names_from = stop_sequence, values_from = count_stop_sequence, values_fill = 0,names_prefix = "S_")

head(stops_by_trip)
```

Drop the trips with just 2 stops (inconsistent geometry)

```{r}
stops_by_trip_filtered <- stops_by_trip[!(stops_by_trip$S_0 == 1 & stops_by_trip$S_1 == 1 & apply(stops_by_trip[,4:length(stops_by_trip)], 1, function(x) all(x == 0))), ]

head(stops_by_trip_filtered)

```
__Take these trips and drops them from the sf object__
__Review if these are really inconsistent__


Plotting filtered geometries

```{r}
geo_from_stops_filtered <- gtfstools::get_trip_geometry(brt_gtfs, trip_id = c("BC26E0001-2-3" , "BC26E0001-3-3"))
```


Sample of trips

```{r}
set.seed(123) 

sample_500 <- sample(stops_by_trip_filtered$trip_id,500)

head(sample_500)

```

```{r}
geo_from_stops_sample_500 <- gtfstools::get_trip_geometry(brt_gtfs, trip_id = sample_500)
```

Plotting sample (Error)

```{r}
ggplot() +
  geom_sf(data = geo_from_stops_sample_500) +
  theme_minimal()
```
The plotting issue started at a 1000 trip sample. As it is random, this might change.


##### One by one plotting

Extract stops_by_trip to excel

```{r}
# write_xlsx(stops_by_trip,"Test/stops_by_trip.xlsx")
```

Extract stops_by_trip_filtered to excel

```{r}
# write_xlsx(stops_by_trip_filtered,"Test/stops_by_trip_filtered.xlsx")
```


###### Case 1: One only point (not working)

Subsetting geometries

```{r}
geo_from_stops_1x1_1 <- gtfstools::get_trip_geometry(brt_gtfs, trip_id = "BOJQ70001-3-3")
```

Plotting 1x1

Basic geo map (not working)

```{r}
# ggplot() +
#   geom_sf(data = geo_from_stops_1x1_1) +
#   theme_minimal()
```

Filtering stop times table

```{r}
filter(brt_gtfs$stop_times, trip_id == "BOJQ70001-3-3")
```


###### Case 2: Two points

Subsetting geometries

```{r}
geo_from_stops_1x1_2 <- gtfstools::get_trip_geometry(brt_gtfs, trip_id = "BC26E0001-10-3")
```

Plotting 1x1

Basic geo map

```{r}
ggplot() +
  geom_sf(data = geo_from_stops_1x1_2) +
  theme_minimal()
```
Empty geometry


Filtering stop times table

```{r}
filter(brt_gtfs$stop_times, trip_id == "BC26E0001-10-3")
```
Does not make sense

###### Case 3: Tree points

Subsetting geometries

```{r}
geo_from_stops_1x1_3 <- gtfstools::get_trip_geometry(brt_gtfs, trip_id = "BOJLO0009-6-3")
```

Plotting 1x1

Basic geo map

```{r}
ggplot() +
  geom_sf(data = geo_from_stops_1x1_3) +
  theme_minimal()
```
Filtering stop times table

```{r}
filter(brt_gtfs$stop_times, trip_id == "BOJLO0009-6-3")
```

Geographically makes sense, unsure if in a functional way.

Filtering stop  table

```{r}
filter(brt_gtfs$stops, stop_id %in% c("87927","88823", "87927"))
```
The plotted geometry is consistent in terms of the origin and destination location, however, it does not account for the real geographical route of the trip.

__Is this adjusted when using the street network?__


###### Case 4: Four points


Subsetting geometries

```{r}
geo_from_stops_1x1_4 <- gtfstools::get_trip_geometry(brt_gtfs, trip_id = "CN1340030-10-3")
```

Plotting 1x1

Basic geo map

```{r}
ggplot() +
  geom_sf(data = geo_from_stops_1x1_4) +
  theme_minimal()
```
Filtering stop times table

```{r}
filter(brt_gtfs$stop_times, trip_id == "CN1340030-10-3")
```

Geographically makes sense, unsure if in a functional way.

Filtering stop  table

```{r}
filter(brt_gtfs$stops, stop_id %in% c("5215","93431", "92919", "5215"))
```


test (Working)

```{r}
geo_from_stops_filtered <- gtfstools::get_trip_geometry(brt_gtfs, trip_id = stops_by_trip_filtered$trip_id)
```


Basic geo map (not working)

```{r}
# ggplot() +
#   geom_sf(data = geo_from_stops_filtered) +
#   theme_minimal()
```

```{r}
summary(geo_from_stops_filtered)
```
Geometry type

```{r}
unique(st_geometry_type(geo_from_stops_filtered))
```
Valid geometry

```{r}
st_is_valid(geo_from_stops_filtered)
```
Remove invalid geometries

```{r}
invalid_geometries <- !st_is_valid(geo_from_stops_filtered)

geo_from_stops_filtered <- geo_from_stops_filtered[invalid_geometries == FALSE, ]
```

Check for valid geometries again

```{r}
unique(st_is_valid(geo_from_stops_filtered))
```
Empty geometries (not working)

```{r}
# st_is_empty(geo_from_stops_filtered)
```



Replotting (not working)

```{r}
# ggplot() +
#   geom_sf(data = geo_from_stops_filtered) +
#   theme_minimal()
```


Orders descending

```{r}
head(trips_by_stop[order(desc(trips_by_stop$count_transit)),])
```

Orders ascending

```{r}
head(trips_by_stop[order((trips_by_stop$count_transit)),])
```

##### High and low traffic stations

__Based on misleading count__

```{r}
filter(brt_gtfs$stops, stop_id == "97095" | stop_id == "88730" )
```
Filtering sf object

```{r}
filter(brt_stations_sf,stop_id == "97095" | stop_id == "88730") %>%
  plot()
```

Filtering the stop table based on t



### Frequencies (non existing)

### Calendar dates

```{r}
head(brt_gtfs$calendar_dates)
```
Number of exceptions

```{r}
n_distinct(brt_gtfs$calendar_dates)
```
#### Exception type

Exeption_type: "Indicates whether service is available on the date specified in the date field.

Valid options are:

1 - Service has been added for the specified date.
2 - Service has been removed for the specified date." 

```{r}
unique(brt_gtfs$calendar_dates$exception_type)
```
Number of different dates in calendar dates

```{r}
unique(brt_gtfs$calendar_dates$date)
```
It seems to be holidays in Colombia.

#### Service id

```{r}
n_distinct(brt_gtfs$calendar_dates$service_id)
```

# Multipurpose survey

## Reading the data

### ZPU layer

```{r}
geo_zpu <- st_read("Data/Survey/Shape/ShapeEM2021/EM2021_UPZ.shp")
```
Geometry

```{r}
qtm(geo_zpu)
```

### Survey data

#### Main forms

Downloading and reading from source

```{r}
# url<- "https://www.sdp.gov.co/sites/default/files/encuestas-multiproposito/20230620em2021.zip"
# 
# download.file(url,"Data/Survey/CSV_Main/20230620em2021.zip")
# 
# unzip("Data/Survey/CSV_Main/20230620em2021.zip",exdir = "Data/Survey/CSV_Main")
# 
# survey_raw <- read_csv("Data/Survey/CSV_Main/20230620EM2021.csv")
```

Reading from local

```{r}
survey_raw <- read_csv("Data/Survey/CSV_Main/20230620EM2021.csv")
```
Preview

```{r}
head(survey_raw,10)
```

#### Additional variables

Downloading and reading from source

```{r}
# url<- "https://www.sdp.gov.co/sites/default/files/encuestas-multiproposito/20230220_variables_adicionales_em2021_csv.zip"
# 
# download.file(url,"Data/Survey/CSV_Additional/20230220_variables_adicionales_em2021_csv.zip")
# 
# unzip("Data/Survey/CSV_Additional/20230220_variables_adicionales_em2021_csv.zip",exdir = "Data/Survey/CSV_Additional")
# 
# survey_add_raw <- read_csv("Data/Survey/CSV_Additional/20230220_variables_adicionales_em2021.csv")
```

Reading from local

```{r}
survey_add_raw <- read_csv("Data/Survey/CSV_Additional/20230220_variables_adicionales_em2021.csv")
```

Preview

```{r}
head(survey_add_raw,10)
```

## Data inspection

### ZPU layer

CRS

```{r}
st_crs(geo_zpu)
```
Summary

```{r}
summary(geo_zpu)
```
UPZEM: Numeric
UPZEM2: String

### Survey data

#### Main forms

Data type

```{r}
Datatypelist_survey <- survey_raw %>% 
  summarise_all(class) %>%
  pivot_longer(everything(), 
               names_to="All_variables", 
               values_to="Variable_class")

Datatypelist_survey
```

__N/A's review in key fields__

##### Profiling

Summary

```{r}
introduce(survey_raw)
```
Missing values

```{r}
plot_missing(survey_raw)
```

Missing values on ID fields

```{r}
survey_raw %>% select(directorio,directorio_per, directorio_hog, dpto, mpio,clase,cod_localidad, nombre_localidad, cod_upz_grupo, nombre_upz_grupo, estrato2021, nombre_estrato, fex_c) %>%
  plot_missing(.)

```


##### Example

directorio = "220102"

```{r}
filter(survey_raw, directorio == "220102") %>%
  select(directorio,directorio_per, # ID
         orden, # Order in home
         npcep4, # Age
         npcep6, # Relation to Household leader
         npcep11a) # Place of birth
```


#### Additional variables

Data type

```{r}
Datatypelist_survey_add <- survey_add_raw %>% 
  summarise_all(class) %>%
  pivot_longer(everything(), 
               names_to="All_variables", 
               values_to="Variable_class")

Datatypelist_survey_add
```

##### Profiling

Summary

```{r}
introduce(survey_add_raw)
```
Missing values

```{r}
plot_missing(survey_raw)
```

Missing values on ID fields

```{r}
survey_add_raw %>% select(directorio, directorio_per, directorio_hog) %>%
  plot_missing(.)

```

##### Example

directorio = "220102"

```{r}
filter(survey_add_raw, directorio == "220102") %>%
  select(
    directorio,directorio_per, # ID
    N_fuerza_trabajo, # In labour market
    N_informal, # Informal
    N_analfabeta, # Illiterate
    N_pobre_ipm, # MPI poor
    N_codigo_upz_trabajo, # ZPU ID of workplace
    N_INGTOT_PER, # Total income 
    N_pobre_monetario) # Monetary poverty
```

