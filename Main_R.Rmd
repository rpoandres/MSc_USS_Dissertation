---
title: "Accessibility impact of transport infrastructure: Spatial assessment of Bogota's future metro system"
author: "Andrés Restrepo Jiménez"
date: '2023-06-19'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
library(r5r)
library(accessibility)
library(ggplot2)
library(aopdata)
library(gtfstools)
library(readr)
library(dplyr)
library(tidyr)
library(st)
library(httr)
library(sf)
library(patchwork)
library(tmap)
library(tmaptools)
library(forcats)
library(scales)
library(writexl)
library(DataExplorer)
library(osmextract)
library(osmdata)
library(leaflet) # for making the interactive map
library(elevatr) # DEM (Digital Elevation Model)
library(raster)
#library(terra) # Not installed
```

## Temporary directory

Location

```{r}
tempdir()
```

Deletes

```{r}
# unlink(tempdir(), recursive = TRUE)
```

## Memory setup

```{r}
options(java.parameters = "-Xmx4G")
```

# Bus Rapid Transit network (BRT)

## Downloading the data

Setting the temp file path

```{r}
brt_path <- tempfile("brt", fileext = ".zip")
```

Downloading the BRT GTFS data

```{r}
httr::GET(
  "https://storage.googleapis.com/gtfs-estaticos/GTFS-2023-06-21.zip",
  httr::write_disk(brt_path)
)
```

Initial: The GTFS data is a static feed (2021-07-04) provided by the Transport Secretary of Bogota City Council available [here](https://datos.movilidadbogota.gov.co/datasets/599751603a494051b15ac3d4f1f38ec5/about).

Update: The data was updated with static feed (2023-06-21) provided by Transmilenio in their open data webpage and available [here](https://datosabiertos-transmilenio.hub.arcgis.com/documents/gtfs-est%C3%A1ticos-2023-06-21/about).

## Data inspection

Review of tables of downloaded data

```{r}
unzip(brt_path, list = TRUE)
```

```{r}
brt_gtfs <- read_gtfs(brt_path)

names(brt_gtfs)
```

### Profiling

```{r}
plot_str(brt_gtfs)
```

### Agency

```{r}
head(brt_gtfs$agency)
```

### Routes

```{r}
head(brt_gtfs$routes)
```

#### Id

Number of rows in route table

```{r}
nrow(brt_gtfs$routes)
```

Number of route id's.

```{r}
n_distinct(brt_gtfs$routes$route_id)
```

There was 547 different routes in the BRT network, and 1086 in the new data.

#### Description

Number of descriptions

```{r}
n_distinct(brt_gtfs$routes$route_desc)
```

Description texts

```{r}
unique(brt_gtfs$routes$route_desc)
```

#### Type

Number of types

```{r}
n_distinct(brt_gtfs$routes$route_type)
```

Type texts

```{r}
unique(brt_gtfs$routes$route_type)
```

Consistent with official GTFS [specification](https://gtfs.org/schedule/reference/#routestxt).

### Trips

```{r}
head(brt_gtfs$trips)
```

**How can you tell the direction?** **It does not have the shape id**

Number of routes in table

```{r}
n_distinct(brt_gtfs$trips$route_id)
```

Number of uniques entries

```{r}
n_distinct(brt_gtfs$trips)
```

There were 158976 trips included in the initial BRT GTFS data and 179454 in the updated data.

### Stops

```{r}
head(brt_gtfs$stops)
```

Number of stations

```{r}
n_distinct(brt_gtfs$stops)
```

Convert stops to sf

```{r}
brt_stations_sf <- st_as_sf(brt_gtfs$stops,coords = c("stop_lon", "stop_lat"))
```

Plot stations

```{r}
brt_stations_sf %>%
  st_geometry() %>%
  plot()
```

Basic geo map

```{r}
ggplot() +
  geom_sf(data = brt_stations_sf) +
  theme_minimal()
```

#### Id

Number of rows in station table

```{r}
n_distinct(brt_gtfs$stops$stop_id)
```

There were 7819 different stations in the BRT network, and 8214 in the new data.

#### Stop code

Number of rows in station table

```{r}
n_distinct(brt_gtfs$stops$stop_code)
```

Stop code and stop id seem to be equivalent.

### Calendar

```{r}
head(brt_gtfs$calendar)
```

From 1-5, it is the same schedule in the intial data, 2-5 in the new data.


### Calendar dates

```{r}
head(brt_gtfs$calendar_dates)
```

Number of exceptions

```{r}
n_distinct(brt_gtfs$calendar_dates)
```

#### Exception type

Exeption_type: "Indicates whether service is available on the date specified in the date field.

Valid options are:

1 - Service has been added for the specified date. 2 - Service has been removed for the specified date."

```{r}
unique(brt_gtfs$calendar_dates$exception_type)
```

Number of different dates in calendar dates

```{r}
unique(brt_gtfs$calendar_dates$date)
```

It seems to be holidays in Colombia.

#### Service id

```{r}
n_distinct(brt_gtfs$calendar_dates$service_id)
```




### Shapes

```{r}
head(brt_gtfs$shapes)
```

Number of shapes entries in table

```{r}
n_distinct(brt_gtfs$shapes$shape_id)
```

Number of unique entries

```{r}
n_distinct(brt_gtfs$shapes)
```

#### Geometry

Getting geometry from new data

```{r}
geo_shapes <- gtfstools::get_trip_geometry(brt_gtfs, file = "shapes")
```

The new object is already a sf object.

Review

```{r}
head(geo_shapes)
```

Plotting

```{r}
# plot(geo_from_stops_test)
```

Plotting geometry onlyv (too big)

```{r}
# geo_shapes %>%
#   st_geometry() %>%
#   plot()
```

Basic geo map (too big)

```{r}
# ggplot() +
#   geom_sf(data = geo_shapes) +
#   theme_minimal()
```

##### Sample of geometries

```{r}
set.seed(123) 

sample <- sample(brt_gtfs$trips$trip_id,1000)

head(s_500)
```
Subsetting geometries

```{r}
geo_shapes_filtered <- gtfstools::get_trip_geometry(brt_gtfs, trip_id = sample)
```


```{r}
head(geo_shapes_sample)
```
Plotting sample geometries

```{r}
ggplot() +
  geom_sf(data = geo_shapes_sample) +
  theme_minimal()
```


##### Check for valid geometries

```{r}
unique(st_is_valid(geo_shapes))
```
There are invalid geometries in the new data.

##### Empty geometries (not working)

```{r}
unique(st_is_empty(geo_shapes))
```
There are not empty geometries in new data set.

##### Remove invalid geometries (not used in new data yet)

```{r}
# invalid_geometries <- !st_is_valid(geo_from_stops_filtered)
# 
# geo_from_stops_filtered <- geo_from_stops_filtered[invalid_geometries == FALSE, ]
```


### Stops times

```{r}
summary(brt_gtfs$stop_times)
```

```{r}
head(brt_gtfs$stop_times)
```

```{r}
brt_gtfs$stop_times
```

Filter stop sequence 0 values

```{r}
filter(brt_gtfs$stop_times, stop_sequence == 0)
```

Initial data: Count of 0 stop sequence values. New data: Zero entries with 0 value in stop sequence field.

```{r}
stop_cero_sequence <- filter(brt_gtfs$stop_times, stop_sequence == 0) %>%
  group_by(stop_id) %>%
  summarize(count_cero = n()) #%>%

stop_cero_sequence <- stop_cero_sequence[order(desc(stop_cero_sequence$count_cero)),]

```

Blank output.

#### Trip Id

```{r}
n_distinct(brt_gtfs$stop_times$trip_id)
```

Sorting by trip id

```{r}
brt_gtfs$stop_times[order(trip_id)]
```

**Review suffix structure**

#### Stop sequence

Unique value in stop_sequence field

```{r}
n_distinct(brt_gtfs$stop_times$stop_sequence)
```

Histogram on stop sequence values

```{r}
histo_stop_sequence <- ggplot(brt_gtfs$stop_times, aes(x=stop_sequence)) +
  ggtitle("Histogram of stop sequence values") + 
  geom_histogram() + xlab("Stop sequence")
histo_stop_sequence
```

Multiple stations with "1" values in the stop sequence.

Filter entries with zero values in stop time stop sequence field

```{r}
filter(brt_gtfs$stop_times, stop_sequence==0)
```

Zero entries with zero value in the stop sequence field

Filter a specific trip

##### Number of stations by trip (remove)


Adjusted count

```{r}
stops_by_trip <- brt_gtfs$stop_times %>%
  group_by(trip_id, stop_sequence) %>%
  summarize(count_stop_sequence = n()) %>%
  pivot_wider(names_from = stop_sequence, values_from = count_stop_sequence, values_fill = 0,names_prefix = "S_")

head(stops_by_trip)
```
Extract stops_by_trip to excel

```{r}
write_xlsx(stops_by_trip,"Test/stops_by_trip.xlsx")
```



##### Case 1 

Two stops

```{r}
filter(brt_gtfs$stop_times, trip_id == "BC42D0021-04-2_T_1785")
```

Review of individual geometry

```{r}
geo_case_1 <- gtfstools::get_trip_geometry(brt_gtfs, trip_id = "BC42D0021-04-2_T_1785")
```

The new object is already a sf object.

Plotting geometry only

```{r}
ggplot() +
  geom_sf(data = geo_case_1) +
  theme_minimal()
```

Although, there are only 2 points, with the shape table data, the geometry output shows a smooth route.

##### Case 2

Tree stops

```{r}
filter(brt_gtfs$stop_times, trip_id == "BO7ED0007-02-2_T_2192")
```

Review of individual geometry

```{r}
geo_case_2 <- gtfstools::get_trip_geometry(brt_gtfs, trip_id = "BO7ED0007-02-2_T_2192")
```


Plotting geometry only

```{r}
ggplot() +
  geom_sf(data = geo_case_2) +
  theme_minimal()
```

##### Case 3

Four stops

```{r}
filter(brt_gtfs$stop_times, trip_id == "BCGIA0007-13-3_Z_6441")
```

Same example with -2 suffix

```{r}
filter(brt_gtfs$stop_times, trip_id == "BCGIA0007-13-3_Z_6441-2")
```

Review of individual geometry

```{r}
geo_case_3 <- gtfstools::get_trip_geometry(brt_gtfs, trip_id = "BCGIA0007-13-3_Z_6441")
```


Plotting geometry only

```{r}
ggplot() +
  geom_sf(data = geo_case_3) +
  theme_minimal()
```
__Non-continous geometry__


### Frequencies (blank)

```{r}
head(brt_gtfs$frequencies)
```

```{r}
brt_gtfs$frequencies
```

There is no data in the frequencies table.

### Fare attributes

```{r}
head(brt_gtfs$fare_attributes)
```

```{r}
brt_gtfs$fare_attributes
```

Types of fare (price) information by agency.

Transfers
1. 0 indicate no transfers permitted.
NA. indicates Unlimited transfers are permitted.

### Fare rules

```{r}
head(brt_gtfs$fare_rules)
```

```{r}
brt_gtfs$fare_rules
```

#### Fare id

```{r}
unique(brt_gtfs$fare_rules$fare_id)
```
Fare 2 missing

#### Route id

```{r}
length(unique(brt_gtfs$fare_rules$route_id))
```
Fare information for 1086 routes.


## Data cleaning (pending)

# BRT network (pending)

## Data reading

Open Street Map Data downloaded from: <https://export.hotosm.org/es/v3/>

```{r}
osm_network <- oe_read("Data/Network/Bogota_general_network.osm.pbf") 
```

Plotting

```{r}
par(mar = rep(0.1, 4))
plot(sf::st_geometry(osm_network))
```

## Data inspection

### CRS

```{r}
st_crs(osm_network)
```

### Profilling

```{r}
plot_missing(osm_network)
```

Filter by highway value

```{r}
osm_by_highway<- osm_network %>%
  group_by(highway) %>%
  summarize(count_entry = n()) %>%
  arrange(desc(count_entry))
  

osm_by_highway
```

Plotting by highway value

```{r}
osm_subsetting <- osm_by_highway %>%
  filter(., highway == "residential")


par(mar = rep(0.1, 4))
plot(sf::st_geometry(osm_subsetting))
```

Interactive map by subsetting value

```{r}
# leaflet() %>% 
#   addTiles() %>% 
#   addPolylines(data = osm_subsetting)

```

**What sub-setting should be done before the accessibility modelling?**

## Data cleaning

# Metro system (pending)

## Data reading

## Data inspection

## Data cleaning

# Multipurpose survey

## Reading the data

### ZPU layer

```{r}
geo_zpu <- st_read("Data/Survey/Shape/ShapeEM2021/EM2021_UPZ.shp")
```

Geometry

```{r}
qtm(geo_zpu)
```

### Survey data

#### Main forms

Downloading and reading from source

```{r}
# url<- "https://www.sdp.gov.co/sites/default/files/encuestas-multiproposito/20230620em2021.zip"
# 
# download.file(url,"Data/Survey/CSV_Main/20230620em2021.zip")
# 
# unzip("Data/Survey/CSV_Main/20230620em2021.zip",exdir = "Data/Survey/CSV_Main")
# 
# survey_raw <- read_csv("Data/Survey/CSV_Main/20230620EM2021.csv")
```

Reading from local

```{r}
survey_raw <- read_csv("Data/Survey/CSV_Main/20230620EM2021.csv")
```

Preview

```{r}
head(survey_raw,10)
```

#### Additional variables

Downloading and reading from source

```{r}
# url<- "https://www.sdp.gov.co/sites/default/files/encuestas-multiproposito/20230220_variables_adicionales_em2021_csv.zip"
# 
# download.file(url,"Data/Survey/CSV_Additional/20230220_variables_adicionales_em2021_csv.zip")
# 
# unzip("Data/Survey/CSV_Additional/20230220_variables_adicionales_em2021_csv.zip",exdir = "Data/Survey/CSV_Additional")
# 
# survey_add_raw <- read_csv("Data/Survey/CSV_Additional/20230220_variables_adicionales_em2021.csv")
```

Reading from local

```{r}
survey_add_raw <- read_csv("Data/Survey/CSV_Additional/20230220_variables_adicionales_em2021.csv")
```

Preview

```{r}
head(survey_add_raw,10)
```

## Data inspection

### ZPU layer

CRS

```{r}
st_crs(geo_zpu)
```

Summary

```{r}
summary(geo_zpu)
```

UPZEM: Numeric UPZEM2: String

### Survey data

#### Main forms

Data type

```{r}
Datatypelist_survey <- survey_raw %>% 
  summarise_all(class) %>%
  pivot_longer(everything(), 
               names_to="All_variables", 
               values_to="Variable_class")

Datatypelist_survey
```

##### Profiling

Summary

```{r}
introduce(survey_raw)
```

Missing values

```{r}
plot_missing(survey_raw)
```

Missing values on ID fields

```{r}
survey_raw %>% select(directorio,directorio_per, directorio_hog, dpto, mpio,clase,cod_localidad, nombre_localidad, cod_upz_grupo, nombre_upz_grupo, estrato2021, nombre_estrato, fex_c) %>%
  plot_missing(.)

```

Missing values by ZPU

```{r}
na_by_zpu <- survey_raw %>%
  group_by(cod_upz_grupo) %>%
  summarize(count_entry = n()) %>%
  mutate(percentage_entry = count_entry / nrow(survey_raw) * 100) %>%
  arrange(desc(percentage_entry))

head(na_by_zpu)
```

Missing ZPU by "directorio"

```{r}
entry_by_directorio <- survey_raw %>%
  group_by(directorio) %>%
  summarize(count_entry = n(),count_na = sum(is.na(cod_upz_grupo))) %>%
  mutate(percentage_entry = count_entry / nrow(survey_raw) * 100) %>%
  mutate(control = ifelse(count_entry == count_na,"All na's", "None")) %>%
  mutate(diff = count_entry - count_na) %>%
  arrange((diff))

entry_by_directorio
```

Filter equal values

```{r}
entry_by_directorio_control <- filter(entry_by_directorio, control == "None") %>%
  mutate(control_diff = diff==count_entry)

unique(entry_by_directorio_control$control_diff)
```

All entries, either have all NA's value per "directorio" or none.

Missing ZPU

```{r}
filter(survey_raw, is.na(cod_upz_grupo))

```

##### Example

directorio = "220102"

```{r}
filter(survey_raw, directorio == "220102") %>%
  select(directorio,directorio_per, directorio_hog, # ID
         cod_upz_grupo, # ZPU code
         nombre_upz_grupo, # ZPU name
         orden, # Order in home
         npcep4, # Age
         npcep6, # Relation to Household leader
         npcep11a) # Place of birth
```

#### Additional variables

Data type

```{r}
Datatypelist_survey_add <- survey_add_raw %>% 
  summarise_all(class) %>%
  pivot_longer(everything(), 
               names_to="All_variables", 
               values_to="Variable_class")

Datatypelist_survey_add
```

##### Profiling

Summary

```{r}
introduce(survey_add_raw)
```

Missing values

```{r}
plot_missing(survey_raw)
```

Missing values on ID fields

```{r}
survey_add_raw %>% select(directorio, directorio_per, directorio_hog) %>%
  plot_missing(.)

```

##### Example

directorio = "220102"

```{r}
filter(survey_add_raw, directorio == "220102") %>%
  select(
    directorio,directorio_per, # ID
    N_fuerza_trabajo, # In labour market
    N_informal, # Informal
    N_analfabeta, # Illiterate
    N_pobre_ipm, # MPI poor
    N_codigo_upz_trabajo, # ZPU ID of workplace
    N_INGTOT_PER, # Total income 
    N_pobre_monetario) # Monetary poverty
```

# Elevation data (Not working)

Elevation data on every ZPU polygon

**Should be calculated for the H3 hegagon grid**

```{r}
elevation <- get_elev_raster(geo_zpu, z = 9)
```

```{r}
elevation
```

Plotting test

```{r}
plot(elevation)
plot(geo_zpu, add = TRUE)
```

## Data cleaning (pending)

# Preprocessing

## Data enrichment

## Spatial analysis unit

Hexagons grid??

# Spatial analysis

# Accessiblity modelling

## Current scenario

## Base scenario

## Alternative scenario
